<:Head>
	<title>Recent Article</title>
</:Head>

<div page='blog'>
	<div>
		{{#each posts as post, index}}
		<div class='article {{index == expanded ? "expanded" : ""}}'>
			<div class='title' on:click='toggle(index)'>
				{{post.title}}
				<!-- {{index == expanded}} -->
			</div>

			<link rel="prefetch" href="/images/big.jpeg">
			<div class='article-expand'>
				{{{post.html}}}
			</div>

			<link rel='prefetch' href='{{post.apiLink}}'>

		</div>
		{{/each}}
	</div>
</div>

<style>
	.article {
		/*margin: 5px;*/
		position: relative;
	}

	.title{
		padding: 5px;
		border-bottom: 1px solid #fff;
		background: #000;
		color: #fff;
		padding-bottom: 5px;
		padding-top: 5px;
		font-size: 16px;
		/*height: 1.5em;*/
		/*overflow: hidden;*/
		position: sticky;
		top: 0px;

	}

	.article-expand{
		display: none;
		padding: 5px;
	}

	.expanded .article-expand{
		display: block;
		background: white;
		color: #000;
	}
</style>

<script>
	// import Layout from '../_components/Layout.html';

	export default {
		components: {
			// Layout
		},

		preload({ params, query }) {
			return fetch(`/api/feed`).then(r => r.json()).then(posts => {
				posts.forEach((d, i) => {
					d.expanded = 0
					d.html = ''
					d.apiLink = `/api/article?${d.link}`

					fetch(d.apiLink) // cache links in background
				})

				var expanded = null

				return {posts, expanded};
			});
		},

		methods: {
			toggle(index){
				var currentExpanded = this.get('expanded')
				var expanded = currentExpanded == index ? null : index
				this.set({expanded})

				if (expanded === null) return

				var posts = this.get('posts')

				fetch(posts[expanded].apiLink)
					.then(r => r.text())
					.then(html => {
						var posts = this.get('posts')
						posts[expanded].html = html

						this.set({posts})
					})

			}
		}
	};
</script>