<:Head>
	<title>Recent Article</title>
</:Head>

<div page='blog'>
	<div>
		{{#each posts as post, index}}
		<div class='article {{post.expanded ? "expanded" : ""}}'>
			<div class='title' on:click='toggle(this, index)'>
				{{post.title}}
			</div>

			<div class='article-expand'>
				{{{post.html}}}
			</div>

			<link rel='prefetch' href='{{post.apiLink}}'>

		</div>
		{{/each}}
	</div>
</div>

<style>
	.article {
		position: relative;
	}

	.title{
		padding: 5px;
		border-bottom: 1px solid #fff;
		background: #000;
		color: #fff;
		padding-bottom: 5px;
		padding-top: 5px;
		font-size: 16px;
		position: sticky;
		top: 0px;

	}

	.article-expand{
		display: none;
		padding: 5px;
	}

	.expanded .article-expand{
		display: block;
		background: white;
		color: #000;
	}
</style>

<script>

	export default {
		components: {
		},

		preload({ params, query }) {

			return fetch(`/api/feed`).then(r => r.json()).then(posts => {
				posts.forEach((d, i) => {
					d.html = ''
					d.apiLink = `/api/article?${d.link}`
					d.expanded = false
				})

				return {posts}
			})
		},

		oncreate() {
			var {posts} = this.get()
			posts.forEach(post => {
				fetch(post.apiLink).then(r => r.text()).then(html => {
					post.html = html
					this.set({posts})
				})
			})

			console.log(posts)
		},

		methods: {
			toggle(node, index){
				var {posts} = this.get()

				var post = posts[index]
				post.expanded = !post.expanded

				this.set({posts})

				node.scrollIntoView(true)
			}
		}
	}
</script>